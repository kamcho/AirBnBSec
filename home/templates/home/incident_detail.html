{% extends 'users/base.html' %}
{% load static %}
{% load form_filters %}
{% load humanize %}
{% load security_filters %}

{% block title %}Incident {{ incident.incident_id }} - AirBnBSec{% endblock %}

{% block extra_css %}
<style>
    /* Video Upload Modal Styles */
    .modal-content {
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        overflow: hidden;
    }
    
    .modal-header {
        background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
        padding: 1.5rem 2rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .modal-title {
        font-weight: 600;
        color: #e2e8f0;
        font-size: 1.25rem;
        letter-spacing: 0.3px;
    }
    
    .modal-body {
        background: #1e293b;
        padding: 2rem;
    }
    
    .modal-footer {
        background: #1e293b;
        border-bottom-left-radius: 12px;
        border-bottom-right-radius: 12px;
        padding: 1.25rem 2rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .form-label {
        color: #cbd5e1;
        font-weight: 500;
        margin-bottom: 0.75rem;
        display: block;
        font-size: 0.95rem;
    }
    
    .form-control {
        background-color: #1e293b;
        border: 1px solid #334155;
        color: #f1f5f9;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        transition: all 0.2s ease;
        font-size: 0.95rem;
    }
    
    .form-control:focus {
        background-color: #1e293b;
        border-color: #6366f1;
        color: #f1f5f9;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }
    
    .form-control::placeholder {
        color: #64748b;
        opacity: 1;
    }
    
    textarea.form-control {
        min-height: 120px;
        resize: vertical;
        line-height: 1.5;
    }
    
    .form-text {
        color: #94a3b8 !important;
        font-size: 0.85rem;
        margin-top: 0.5rem;
        display: flex;
        align-items: center;
    }
    
    .form-text i {
        margin-right: 0.5rem;
        font-size: 1rem;
    }
    
    .btn-close {
        filter: invert(1) grayscale(100%) brightness(200%);
        opacity: 0.7;
        transition: all 0.2s ease;
        padding: 0.75rem;
        margin: -0.5rem -0.5rem -0.5rem auto;
    }
    
    .btn-close:hover {
        opacity: 1;
        transform: rotate(90deg);
    }
    
    /* Custom File Upload */
    .custom-file-upload {
        display: block;
        background: rgba(99, 102, 241, 0.1);
        border: 2px dashed #4f46e5;
        border-radius: 8px;
        padding: 2rem 1.5rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 1rem;
    }
    
    .custom-file-upload:hover {
        background: rgba(99, 102, 241, 0.15);
        border-color: #6366f1;
    }
    
    .custom-file-upload i {
        font-size: 2rem;
        color: #818cf8;
        margin-bottom: 0.75rem;
        display: block;
    }
    
    .custom-file-upload .file-name {
        font-size: 0.9rem;
        color: #94a3b8;
        margin-top: 0.5rem;
        word-break: break-all;
    }
    
    .file-input {
        display: none;
    }
    
    /* Buttons */
    .btn {
        font-weight: 500;
        padding: 0.625rem 1.5rem;
        border-radius: 8px;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.95rem;
    }
    
    .btn i {
        font-size: 1.1em;
        line-height: 1;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        border: none;
        color: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .btn-primary:hover {
        background: linear-gradient(135deg, #4338ca 0%, #6d28d9 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
    }
    
    .btn-primary:active {
        transform: translateY(0);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
    .btn-secondary {
        background: #334155;
        border: 1px solid #475569;
        color: #e2e8f0;
    }
    
    .btn-secondary:hover {
        background: #3e4c5e;
        border-color: #64748b;
        color: #f1f5f9;
    }
    
    /* Progress Bar */
    .progress {
        height: 8px;
        border-radius: 4px;
        background-color: #1e293b;
        overflow: hidden;
        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
    .progress-bar {
        background: linear-gradient(90deg, #4f46e5 0%, #7c3aed 100%);
        transition: width 0.3s ease;
    }
    
    .btn-primary:hover {
        background: linear-gradient(135deg, #4338ca 0%, #6d28d9 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .btn-secondary {
        background: #334155;
        border: none;
        color: #e2e8f0;
        font-weight: 500;
        padding: 0.5rem 1.25rem;
        border-radius: 8px;
        transition: all 0.2s ease;
    }
    
    .btn-secondary:hover {
        background: #475569;
        transform: translateY(-1px);
    }
    
    .progress {
        height: 8px;
        border-radius: 4px;
        background-color: rgba(255, 255, 255, 0.1);
        overflow: hidden;
    }
    
    .progress-bar {
        background: linear-gradient(90deg, #4f46e5 0%, #7c3aed 100%);
    }
    
    /* Custom file input styling */
    .custom-file-upload {
        display: block;
        cursor: pointer;
        padding: 0.75rem 1rem;
        background: #1e293b;
        border: 2px dashed #334155;
        border-radius: 8px;
        text-align: center;
        transition: all 0.2s ease;
        margin-top: 0.5rem;
    }
    
    .custom-file-upload:hover {
        border-color: #4f46e5;
        background: rgba(79, 70, 229, 0.1);
    }
    
    .file-input {
        display: none;
    }
    
    .file-name {
        display: block;
        margin-top: 0.5rem;
        color: #94a3b8;
        font-size: 0.875rem;
    }
    body {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
        min-height: 100vh;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    
    .evidence-thumbnail {
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .evidence-thumbnail:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .evidence-overlay {
        transition: all 0.3s ease;
        opacity: 0;
    }
    
    .evidence-thumbnail:hover .evidence-overlay {
        opacity: 1;
    }
    
    .incident-container {
        max-width: 100%;
        margin: 0;
        padding: 1.5rem;
        width: 100%;
        box-sizing: border-box;
    }
    
    @media (min-width: 768px) {
        .incident-container {
            padding: 2rem 3rem;
        }
    }
    
    @media (min-width: 1200px) {
        .incident-container {
            max-width: 1600px;
            margin: 0 auto;
        }
    }
    
    @media (min-width: 1024px) {
        .incident-container {
            padding: 2rem 3rem;
        }
    }
    
    .incident-header {
        background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 2rem;
        margin: 0 auto 2rem;
        max-width: 1200px;
        width: 100%;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        position: relative;
        box-sizing: border-box;
    }
    
    .incident-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #ef4444, #dc2626);
    }
    
    .incident-title-section {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1.5rem;
    }
    
    .incident-title {
        color: #fff;
        font-weight: 800;
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }
    
    .incident-id {
        color: #94a3b8;
        font-size: 1.1rem;
        font-weight: 500;
    }
    
    .incident-actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }
    
    .btn-action {
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
    }
    
    .btn-edit {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        border: none;
    }
    
    .btn-edit:hover {
        background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
        color: white;
        text-decoration: none;
    }
    
    .btn-delete {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        border: none;
    }
    
    .btn-delete:hover {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        color: white;
        text-decoration: none;
    }
    
    .btn-back {
        background: rgba(107, 114, 128, 0.2);
        color: #9ca3af;
        border: 1px solid rgba(107, 114, 128, 0.3);
    }
    
    .btn-back:hover {
        background: rgba(107, 114, 128, 0.3);
        color: #d1d5db;
        text-decoration: none;
    }
    
    /* Avatar styles */
    .avatar, .comment-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #3b82f6;
        color: white;
        font-weight: 600;
        font-size: 0.9rem;
        text-transform: uppercase;
        flex-shrink: 0;
    }
    
    .avatar img, .comment-avatar img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }
    
    .incident-meta-container {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        width: 100%;
    }

    .incident-meta {
        display: grid;
        grid-template-columns: repeat(3, minmax(200px, 1fr));
        gap: 1.5rem;
        margin: 0;
        padding: 0;
        width: 100%;
    }
    
    @media (max-width: 1200px) {
        .incident-meta {
            grid-template-columns: repeat(3, 1fr);
        }
    }
    
    @media (max-width: 992px) {
        .incident-meta {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    @media (max-width: 576px) {
        .incident-meta {
            grid-template-columns: 1fr;
        }
    }
    
    .meta-card {
        background: rgba(15, 23, 42, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 1.25rem 1rem;
        text-align: center;
        display: flex;
        flex-direction: column;
        min-height: 100%;
        box-sizing: border-box;
        transition: all 0.2s ease;
    }
    
    .meta-label {
        color: #94a3b8;
        font-size: 0.9rem;
        font-weight: 500;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        white-space: nowrap;
    }
    
    .meta-value {
        color: #fff;
        font-size: 1rem;
        font-weight: 600;
        word-break: break-word;
        margin-top: auto;
    }
    
    .severity-high { color: #ef4444; }
    .severity-medium { color: #f59e0b; }
    .severity-low { color: #10b981; }
    
    .status-open { color: #ef4444; }
    .status-investigating { color: #f59e0b; }
    .status-resolved { color: #10b981; }
    .status-closed { color: #6b7280; }
    
    .incident-content {
        display: flex;
        flex-direction: column;
        gap: 2rem;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
    }
    
    @media (min-width: 768px) {
        .incident-content {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
    }
    
    @media (min-width: 1024px) {
        .incident-content {
            flex-direction: row;
            align-items: flex-start;
        }
    }
    
    .main-content {
        flex: 1;
        min-width: 0;
        width: 100%;
        max-width: 1000px;
        margin: 0 auto;
        box-sizing: border-box;
    }
    
    .content-section {
        background: rgba(15, 23, 42, 0.2);
        border-radius: 12px;
        padding: 2rem;
        margin: 0 auto 2.5rem;
        border: 1px solid rgba(255, 255, 255, 0.05);
        width: 100%;
        box-sizing: border-box;
    }
    
    @media (max-width: 768px) {
        .content-section {
            padding: 1.5rem;
            margin-left: 0;
            margin-right: 0;
            border-radius: 0;
            border-left: none;
            border-right: none;
        }
        
        .incident-container {
            padding: 0;
        }
    }
    
    .detail-item {
        display: flex;
        gap: 1.5rem;
        margin: 0 auto 2rem;
        padding-bottom: 2rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        width: 100%;
        max-width: 1200px;
        box-sizing: border-box;
    }
    
    .detail-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    
    .detail-icon {
        color: #3b82f6;
        font-size: 1.25rem;
        margin-top: 0.25rem;
        min-width: 1.5rem;
    }
    
    .detail-content {
        flex: 1;
    }
    
    .detail-label {
        color: #94a3b8;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
        display: block;
    }
    
    .detail-value {
        color: #f1f5f9;
        line-height: 1.6;
    }
    
    .content-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }
    
    .section-title {
        color: #fff;
        font-weight: 700;
        font-size: 1.1rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 0.9rem;
        color: #94a3b8;
    }
    
    .section-title i {
        color: #3b82f6;
        font-size: 1.1rem;
    }
    
    .section-content {
        color: #e2e8f0;
        line-height: 1.6;
        font-size: 1rem;
    }
    
    .section-content p {
        margin-bottom: 1rem;
    }
    
    .section-content p:last-child {
        margin-bottom: 0;
    }
    
    .sidebar {
        display: flex;
        flex-direction: column;
        gap: 2rem;
        width: 100%;
        box-sizing: border-box;
        order: -1;
        padding: 0 1.5rem;
    }
    
    @media (min-width: 1024px) {
        .sidebar {
            position: sticky;
            top: 2rem;
            width: 350px;
            min-width: 350px;
            order: 2;
        }
    }
    
    .status-update-form {
        background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-label {
        color: #f1f5f9;
        font-weight: 600;
        margin-bottom: 0.75rem;
        display: block;
        font-size: 0.9rem;
    }
    
    .form-control, .form-select {
        background: rgba(15, 23, 42, 0.8);
        border: 2px solid rgba(255, 255, 255, 0.1);
        color: #fff;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        width: 100%;
    }
    
    .form-control:focus, .form-select:focus {
        background: rgba(15, 23, 42, 0.9);
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        color: #fff;
    }
    
    .form-control::placeholder {
        color: #64748b;
    }
    
    .btn-update {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        border: none;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        border-radius: 8px;
        color: white;
        transition: all 0.3s ease;
        width: 100%;
    }
    
    .btn-update:hover {
        background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
    }
    
    .updates-section {
        background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    
    .update-item {
        background: rgba(15, 23, 42, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
    }
    
    .update-item:last-child {
        margin-bottom: 0;
    }
    
    .update-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }
    
    .update-type {
        color: #3b82f6;
        font-weight: 600;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .update-date {
        color: #94a3b8;
        font-size: 0.85rem;
    }
    
    .update-content {
        color: #e2e8f0;
        line-height: 1.6;
        font-size: 0.95rem;
    }
    
    .add-update-form {
        background: rgba(15, 23, 42, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 1.5rem;
        margin-top: 1rem;
    }
    
    .btn-add-update {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border: none;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        border-radius: 8px;
        color: white;
        transition: all 0.3s ease;
        width: 100%;
    }
    
    .btn-add-update:hover {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
        .incident-container {
            margin: 1rem;
            padding: 1rem;
        }
        
        .incident-title-section {
            flex-direction: column;
            gap: 1rem;
        }
        
        .incident-content {
            grid-template-columns: 1fr;
        }
        
        .incident-meta {
            grid-template-columns: 1fr;
        }
        
        .incident-actions {
            flex-direction: column;
        }
        
        .btn-action {
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="incident-container">
    <div class="incident-header">
        <div class="incident-title-section">
            <div>
                <h1 class="incident-title">{{ incident.title }}</h1>
                <div class="incident-id">Incident ID: {{ incident.incident_id }}</div>
            </div>
            <div class="incident-actions">
                <a href="{% url 'home:incident_list' %}" class="btn-action btn-back">
                    <i class="bi bi-arrow-left"></i>Back to List
                </a>
                {% if user == incident.reported_by or user.is_superuser %}
                <a href="{% url 'home:incident_update' incident.pk %}" class="btn-action btn-edit">
                    <i class="bi bi-pencil"></i>Edit
                </a>
                <a href="{% url 'home:incident_delete' incident.pk %}" class="btn-action btn-delete">
                    <i class="bi bi-trash"></i>Delete
                </a>
                {% endif %}
            </div>
        </div>
        
        <div class="incident-meta-container">
            <div class="incident-meta-container">
                <div class="incident-meta">
                    <div class="meta-card">
                        <div class="meta-label">
                            <i class="bi bi-tag"></i>Type
                        </div>
                        <div class="meta-value">{{ incident.get_incident_type_display }}</div>
                    </div>
                    <div class="meta-card">
                        <div class="meta-label">
                            <i class="bi bi-exclamation-octagon"></i>Severity
                        </div>
                        <div class="meta-value severity-{{ incident.severity|lower }}">{{ incident.get_severity_display }}</div>
                    </div>
                    <div class="meta-card">
                        <div class="meta-label">
                            <i class="bi bi-flag"></i>Status
                        </div>
                        <div class="meta-value status-{{ incident.status|lower }}">{{ incident.get_status_display }}</div>
                    </div>
                </div>
                <div class="incident-meta">
                    <div class="meta-card">
                        <div class="meta-label">
                            <i class="bi bi-calendar-event"></i>Incident Date
                        </div>
                        <div class="meta-value">{{ incident.incident_date|date:"M d, Y H:i" }}</div>
                    </div>
                    <div class="meta-card">
                        <div class="meta-label">
                            <i class="bi bi-clock"></i>Reported
                        </div>
                        <div class="meta-value">{{ incident.reported_date|date:"M d, Y H:i" }}</div>
                    </div>
                    <div class="meta-card">
                        <div class="meta-label">
                            <i class="bi bi-person"></i>Reported By
                        </div>
                        <div class="meta-value">{{ incident.reported_by.get_full_name|default:incident.reported_by.username }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Video Explanation Section -->
    {% if not explainer_video and user == incident.reported_by  %}
    <!-- Success Message (initially hidden) -->
    <div id="uploadSuccessMessage" class="alert alert-success d-none" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i> Video uploaded successfully!
    </div>
    
    <!-- Video Upload Modal -->
    <div class="modal fade" id="uploadVideoModal" tabindex="-1" aria-labelledby="uploadVideoModalLabel" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-gray-800 border border-gray-700">
                <div class="modal-header border-b border-gray-700">
                    <h5 class="modal-title text-white" id="uploadVideoModalLabel">Upload Video Explanation</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="video-upload-form" action="{% url 'home:upload_video' incident.id %}" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="id_title" class="form-label">Title</label>
                            <input type="text" 
                                   class="form-control bg-gray-700 border-gray-600 text-white" 
                                   id="id_title" 
                                   name="title" 
                                   required 
                                   placeholder="Enter a title for this video">
                        </div>
                        <div class="mb-3">
                            <label for="id_description" class="form-label">Description (Optional)</label>
                            <textarea class="form-control bg-gray-700 border-gray-600 text-white" 
                                      id="id_description" 
                                      name="description" 
                                      rows="3"
                                      placeholder="Add a description of the video content"></textarea>
                        </div>
                            <div class="mb-3">
                                <label for="id_video" class="form-label">Video File</label>
                                <label for="id_video" class="custom-file-upload">
                                    <i class="bi bi-cloud-arrow-up"></i>
                                    <span>Drag & drop your video here or click to browse</span>
                                    <div class="file-name text-sm mt-2" id="file-name">No file selected</div>
                                </label>
                                <input class="file-input" 
                                       type="file" 
                                       id="id_video" 
                                       name="video" 
                                       required 
                                       accept="video/mp4,video/webm,video/quicktime,video/x-msvideo"
                                       onchange="document.getElementById('file-name').textContent = this.files[0] ? this.files[0].name : 'No file selected'">
                                <div class="form-text">
                                    <i class="bi bi-info-circle"></i>
                                    <span>Supported formats: MP4, WebM, MOV, AVI. Max size: 100MB</span>
                                </div>
                            </div>
                        </div>
                        <div id="upload-progress" class="progress mt-3 d-none">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="modal-footer border-t border-gray-700">
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">
                            <i class="bi bi-x-lg me-1"></i> Cancel
                        </button>
                        <button type="submit" class="btn btn-primary" id="upload-video-btn">
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            <i class="bi bi-upload me-1"></i> Upload Video
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
    
    <div class="detail-item mt-4">
        <div class="detail-icon">
            <i class="bi bi-camera-video"></i>
        </div>
        <div class="detail-content w-full">
            <div class="flex justify-between items-center mb-3">
                <span class="detail-label">Video Explanation</span>
                {% if not explainer_video and user == incident.reported_by or user.is_superuser %}
                <button type="button" 
                        class="btn btn-primary btn-sm" 
                        data-bs-toggle="modal" 
                        data-bs-target="#uploadVideoModal"
                        style="background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); border: none;">
                    <i class="bi bi-upload me-1"></i> Upload Video
                </button>
                {% endif %}
            </div>
            
            <div id="video-container" class="mb-6">
                {% if explainer_video %}
                <div class="video-player bg-gray-900 rounded-lg overflow-hidden mb-4">
                    <video 
                        id="incident-video" 
                        class="w-full" 
                        controls 
                        preload="metadata"
                        style="background-color: #111827;"
                    >
                        <source src="{{ explainer_video.video.url }}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                    <div class="p-4 bg-gray-800/50">
                        <h4 class="text-lg font-medium text-white mb-1">{{ explainer_video.title }}</h4>
                        {% if explainer_video.description %}
                        <p class="text-gray-300 text-sm mb-2">{{ explainer_video.description }}</p>
                        {% endif %}
                        <div class="flex justify-between items-center text-xs text-gray-400">
                            <span>Uploaded by {{ explainer_video.uploaded_by.get_full_name|default:explainer_video.uploaded_by.username }} on {{ explainer_video.created_at|date:"M j, Y" }}</span>
                            {% if user == incident.reported_by or user.is_superuser %}
                            <form action="{% url 'home:delete_video' explainer_video.id %}" method="post" class="delete-video-form">
                                {% csrf_token %}
                                <button type="submit" class="text-red-400 hover:text-red-300 transition-colors" 
                                        onclick="return confirm('Are you sure you want to delete this video?')">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center p-8 border-2 border-dashed border-gray-700 rounded-lg bg-gray-800/50">
                    <i class="bi bi-camera-video text-4xl text-gray-500 mb-3"></i>
                    <p class="text-gray-400 mb-4">No video explanation available yet.</p>
                    {% if user == incident.reported_by or user.is_superuser %}
                    <button type="button" 
                            class="btn btn-primary" 
                            data-bs-toggle="modal" 
                            data-bs-target="#uploadVideoModal"
                            style="background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); border: none;">
                        <i class="bi bi-upload me-2"></i> Upload Video Explanation
                    </button>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="incident-content">
        <div class="main-content">
            <!-- Combined Details Section -->
            <div class="content-section">
                <!-- Description -->
                <div class="detail-item">
                    <div class="detail-icon">
                        <i class="bi bi-file-text"></i>
                    </div>
                    <div class="detail-content">
                        <span class="detail-label">Description</span>
                        <div class="detail-value">
                            {{ incident.description|linebreaks }}
                        </div>
                    </div>
                </div>
                
                <!-- Guest Information -->
                {% if incident.guest_name or incident.guest_email or incident.guest_phone %}
                <div class="detail-item">
                    <div class="detail-icon">
                        <i class="bi bi-person-lines-fill"></i>
                    </div>
                    <div class="detail-content">
                        <span class="detail-label">Guest Information</span>
                        <div class="detail-value">
                            {% if incident.guest_name %}
                                <div class="mb-2">{{ incident.guest_name }}</div>
                            {% endif %}
                            {% if incident.guest_email %}
                                <div class="mb-2"><i class="bi bi-envelope me-2"></i>{{ incident.guest_email }}</div>
                            {% endif %}
                            {% if incident.guest_phone %}
                                <div><i class="bi bi-telephone me-2"></i>{{ incident.guest_phone }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Location Details -->
                {% if incident.location_description %}
                <div class="detail-item">
                    <div class="detail-icon">
                        <i class="bi bi-geo-alt"></i>
                    </div>
                    <div class="detail-content">
                        <span class="detail-label">Location Details</span>
                        <div class="detail-value">
                            {{ incident.location_description|linebreaks }}
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Additional Information -->
                {% if incident.estimated_damage_cost or incident.police_report_number %}
                <div class="detail-item">
                    <div class="detail-icon">
                        <i class="bi bi-clipboard-data"></i>
                    </div>
                    <div class="detail-content">
                        <span class="detail-label">Additional Information</span>
                        <div class="detail-value">
                            {% if incident.estimated_damage_cost %}
                                <div class="mb-2">
                                    <i class="bi bi-cash-stack me-2"></i>
                                    <span>Estimated Damage: </span>
                                    <span class="text-amber-400">Ksh {{ incident.estimated_damage_cost }}</span>
                                </div>
                            {% endif %}
                            {% if incident.police_report_number %}
                                <div>
                                    <i class="bi bi-file-earmark-text me-2"></i>
                                    <span>Police Report: </span>
                                    <span class="text-blue-400">{{ incident.police_report_number }}</span>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Resolution Notes -->
                {% if incident.resolution_notes %}
                <div class="detail-item">
                    <div class="detail-icon">
                        <i class="bi bi-check-circle"></i>
                    </div>
                    <div class="detail-content">
                        <span class="detail-label">Resolution Notes</span>
                        <div class="detail-value">
                            {{ incident.resolution_notes|linebreaks }}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Evidence Section -->
                <div class="detail-item">
                    <div class="detail-icon">
                        <i class="bi bi-images"></i>
                    </div>
                    <div class="detail-content w-full">
                        <div class="flex justify-between items-center mb-3">
                            <span class="detail-label">Evidence</span>
                            {% if user == incident.reported_by or user.is_superuser %}
                            <a href="{% url 'home:add_evidence' incident_id=incident.id %}" class="btn btn-primary btn-sm d-flex align-items-center" style="background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <i class="bi bi-plus-lg me-1"></i> Add Evidence
                            </a>
                            {% endif %}
                        </div>
                        
                        {% if incident.evidence.exists %}
                            <div class="text-muted small mb-3">{{ incident.evidence.count }} file{{ incident.evidence.count|pluralize }} attached</div>
                            
                            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 mb-4">
                                {% for evidence in incident.evidence.all|slice:":8" %}
                                <div class="evidence-thumbnail position-relative rounded overflow-hidden bg-dark" style="height: 120px;">
                                    {% if evidence.file_type == 'image' %}
                                        <img src="{{ evidence.file.url }}" class="img-fluid w-full h-full object-cover" alt="Evidence">
                                    {% elif evidence.file_type == 'video' %}
                                        <div class="d-flex items-center justify-center h-full w-full" style="background: rgba(0,0,0,0.7);">
                                            <i class="bi bi-play-circle text-white" style="font-size: 2rem;"></i>
                                        </div>
                                    {% else %}
                                        <div class="d-flex flex-col items-center justify-center h-full w-full" style="background: rgba(0,0,0,0.5);">
                                            <i class="bi {{ evidence.get_file_icon }} text-white-50" style="font-size: 1.5rem;"></i>
                                            <small class="text-white-50 mt-2 text-center px-2" style="font-size: 0.7rem;">
                                                {{ evidence.file.name|slice:"-15:"|default:"Document" }}
                                            </small>
                                        </div>
                                    {% endif %}
                                    <div class="evidence-overlay absolute bottom-0 left-0 w-full px-2 py-1" style="background: rgba(0,0,0,0.7);">
                                        <div class="flex justify-between items-center">
                                            <span class="text-white text-xs truncate" style="max-width: 70%;" title="{{ evidence.filename }}">
                                                {{ evidence.filename|truncatechars:15 }}
                                            </span>
                                            <div class="flex space-x-1">
                                                <a href="{{ evidence.file.url }}" target="_blank" class="text-white hover:text-blue-300" title="View">
                                                    <i class="bi bi-eye-fill"></i>
                                                </a>
                                                <a href="{{ evidence.file.url }}" download class="text-white hover:text-blue-300" title="Download">
                                                    <i class="bi bi-download"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            {% if incident.evidence.count > 8 %}
                                <div class="text-center">
                                    <a href="{% url 'home:add_evidence' incident_id=incident.id %}" class="text-blue-400 hover:text-blue-300 text-sm">
                                        View all {{ incident.evidence.count }} files <i class="bi bi-arrow-right"></i>
                                    </a>
                                </div>
                            {% endif %}
                            
                        {% else %}
                            <div class="text-center p-6 border-2 border-dashed border-gray-700 rounded-lg bg-gray-800/50">
                                <i class="bi bi-images text-4xl text-gray-500 mb-2"></i>
                                <p class="text-gray-400 mb-4">No evidence files uploaded yet.</p>
                                <a href="{% url 'home:add_evidence' incident_id=incident.id %}" class="btn btn-primary btn-sm">
                                    <i class="bi bi-upload me-1"></i> Upload Evidence
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Add Update Form -->
                <div class="detail-item">
                    <div class="detail-icon">
                        <i class="bi bi-plus-circle"></i>
                    </div>
                    <div class="detail-content w-full">
                        <div class="flex justify-between items-center mb-3">
                            <span class="detail-label">Add Update</span>
                        </div>
                        {% if user == incident.reported_by or user.is_superuser %}
                        <div class="add-update-form bg-gray-800 rounded-lg p-4">
                            <form method="post" action="{% url 'home:add_incident_update' incident.pk %}" class="needs-validation" novalidate>
                                {% csrf_token %}
                                
                                {% if update_form.non_field_errors %}
                                    <div class="alert alert-danger mb-3 p-2 text-sm text-red-400 bg-red-900/50 rounded">
                                        {% for error in update_form.non_field_errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                
                                <div class="mb-3">
                                    <label for="{{ update_form.update_type.id_for_label }}" class="block text-sm font-medium text-gray-300 mb-1">Update Type</label>
                                    {{ update_form.update_type|add_class:"w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500" }}
                                    {% if update_form.update_type.errors %}
                                        <div class="text-red-400 text-sm mt-1">
                                            {{ update_form.update_type.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="mb-4">
                                    <label for="{{ update_form.description.id_for_label }}" class="block text-sm font-medium text-gray-300 mb-1">Description</label>
                                    {{ update_form.description|add_class:"w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500" }}
                                    {% if update_form.description.errors %}
                                        <div class="text-red-400 text-sm mt-1">
                                            {{ update_form.description.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <div class="text-xs text-gray-400 mt-1">Provide details about the update or changes made.</div>
                                </div>
                                
                                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-200 flex items-center justify-center">
                                    <i class="bi bi-plus-circle me-2"></i> Add Update
                                </button>
                            </form>
                        </div>
                        {% else %}
                        <div class="text-center p-4 bg-gray-800/50 rounded-lg border border-dashed border-gray-700">
                            <p class="text-gray-400">Only the incident reporter can add updates.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Comments Section -->
                <div class="detail-item">
                    <div class="detail-icon">
                        <i class="bi bi-chat-left-text"></i>
                    </div>
                    <div class="detail-content w-full">
                        <div class="flex justify-between items-center mb-3">
                            <span class="detail-label">Comments</span>
                        </div>
                        
                        <!-- Comment Form -->
                        <div class="comment-form mb-6">
                            <form method="post" action="{% url 'home:add_comment' incident.id %}" id="comment-form" class="mb-6">
                                {% csrf_token %}
                                <div class="flex items-start space-x-3">
                                    <div class="comment-avatar" title="{{ user.get_full_name|default:user.username }}">
                                        {{ user.get_full_name|default:user.username|slice:':2'|upper }}
                                    </div>
                                    <div class="flex-1">
                                        <div class="relative">
                                            <textarea name="content" id="id_content" rows="3"
                                                      class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                      placeholder="Add a comment..." required></textarea>
                                            <div class="flex justify-between items-center mt-2">
                                                <div class="text-xs text-gray-400">
                                                    Press Ctrl+Enter to submit
                                                </div>
                                                <button type="submit" 
                                                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-md transition duration-200">
                                                    Comment
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <!-- Comments List -->
                        <div id="comments-list" class="space-y-4">
                            {% for comment in incident.comments.all %}
                            <div class="comment-item bg-gray-800/50 border border-gray-700 rounded-lg p-4" id="comment-{{ comment.id }}">
                                <div class="flex items-start space-x-3">
                                    <div class="comment-avatar" title="{{ comment.user_full_name }}">
                                        {{ comment.user_initials }}
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <span class="font-medium text-white">{{ comment.user_full_name }}</span>
                                                <span class="text-xs text-gray-400 ml-2">
                                                    {{ comment.created_at|timesince }} ago
                                                </span>
                                            </div>
                                            {% if user == comment.user or user == incident.reported_by or user.is_superuser %}
                                            <form action="{% url 'home:delete_comment' comment.id %}" method="post" class="comment-delete-form">
                                                {% csrf_token %}
                                                <button type="submit" class="text-gray-400 hover:text-red-400 transition-colors"
                                                        onclick="return confirm('Are you sure you want to delete this comment?')">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </form>
                                            {% endif %}
                                        </div>
                                        <div class="mt-1 text-gray-300">
                                            {{ comment.content|linebreaksbr }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <div class="text-center py-6 text-gray-400">
                                <i class="bi bi-chat-square-text text-3xl mb-2 block"></i>
                                <p>No comments yet. Be the first to comment!</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Client Information -->
            <div class="client-section mb-6">
                <h3 class="section-title">
                    <i class="bi bi-person-badge"></i> Offender Information
                </h3>
                {% if incident.client %}
                    <div class="client-details p-4 bg-gray-800 rounded-lg mb-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-lg font-semibold text-white">
                                {% can_view_offender_name user incident as can_view %}
                                {% if can_view %}
                                    {{ incident.client.get_full_name }}
                                {% else %}
                                    {{ incident.client.get_full_name|mask_person_name }}
                                {% endif %}
                            </h4>
                            <!-- <span class="text-xs px-2 py-1 bg-blue-600 rounded-full">ID: {{ incident.client.id_number }}</span> -->
                        </div>
                        {% if not can_view %}
                        <div class="mb-3 text-sm text-gray-400">
                            To view full offender information, please subscribe.
                        </div>
                        <a href="{% url 'payments:make_payment' %}" class="btn-action btn-edit inline-flex items-center">
                            <i class="bi bi-credit-card"></i> Subscribe to Unlock
                        </a>
                        {% endif %}
                        <div class="space-y-2 text-sm text-gray-300">
                            {% for contact in incident.client.contacts.all %}
                                <div class="flex items-center">
                                    <i class="bi {% if contact.contact_type == 'email' %}bi-envelope{% else %}bi-telephone{% endif %} mr-2"></i>
                                    {{ contact.contact }}
                                    {% if contact.is_primary %}
                                        <span class="ml-2 text-xs bg-green-600 text-white px-1.5 py-0.5 rounded">Primary</span>
                                    {% endif %}
                                </div>
                            {% empty %}
                                <div class="text-gray-400">
                                    {% if user == incident.reported_by or user.is_superuser %}
                                        <div class="mb-2">No contact on file. Please add the offender's phone or email.</div>
                                        <form method="post" action="{% url 'home:add_client_contact' incident.id %}" class="mt-2 space-y-2">
                                            {% csrf_token %}
                                            <div>
                                                <label class="form-label">Contact Type</label>
                                                <select name="contact_type" class="form-select">
                                                    <option value="phone">Phone</option>
                                                    <option value="email">Email</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="form-label">Contact</label>
                                                <input type="text" name="contact" class="form-control" placeholder="e.g. +2547... or name@example.com" required>
                                            </div>
                                            <button type="submit" class="btn btn-primary btn-sm">
                                                <i class="bi bi-plus-lg mr-1"></i>Add Contact
                                            </button>
                                        </form>
                                    {% else %}
                                        No contact on file. Ask the incident creator to add the offender's contact information.
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                        {% if incident.client.name_aliases.all %}
                        <div class="mt-4">
                            <div class="text-xs uppercase tracking-wide text-gray-400 mb-2">Aliases</div>
                            <ul class="list-disc list-inside text-sm text-gray-300 space-y-1">
                                {% for alias in incident.client.name_aliases.all %}
                                    <li>{{ alias.first_name }}{% if alias.last_name %} {{ alias.last_name }}{% endif %}</li>
                                {% empty %}
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <p class="text-gray-400 mb-4">No client associated with this incident</p>
                        <a href="{% url 'home:add_client_to_incident' incident.id %}" class="btn-action btn-edit">
                            <i class="bi bi-plus-lg"></i> Add Offender
                        </a>
                    </div>
                {% endif %}
            </div>

            <!-- Status Update Form -->
            {% if user == incident.reported_by or user.is_superuser %}
            <div class="status-update-form">
                <h3 class="section-title">
                    <i class="bi bi-arrow-repeat"></i> Update Status
                </h3>
                <form method="post" action="{% url 'home:update_incident_status' incident.pk %}">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="{{ status_form.status.id_for_label }}" class="form-label">Status</label>
                        {{ status_form.status }}
                    </div>
                    <div class="form-group">
                        <label for="{{ status_form.resolved_date.id_for_label }}" class="form-label">Resolved Date</label>
                        {{ status_form.resolved_date }}
                    </div>
                    <div class="form-group">
                        <label for="{{ status_form.resolution_notes.id_for_label }}" class="form-label">Resolution Notes</label>
                        {{ status_form.resolution_notes }}
                    </div>
                    <button type="submit" class="btn-update">
                        <i class="bi bi-check-circle me-2"></i>Update Status
                    </button>
                </form>
            </div>
            {% endif %}
            
            <!-- Updates Section -->
            <div class="updates-section">
                <h3 class="section-title">
                    <i class="bi bi-chat-dots"></i> Updates
                </h3>
                
                {% for update in incident.updates.all %}
                    <div class="update-item">
                        <div class="update-header">
                            <span class="update-type">{{ update.get_update_type_display }}</span>
                            <span class="update-date">{{ update.created_at|date:"M d, Y H:i" }}</span>
                        </div>
                        <div class="update-content">{{ update.description|linebreaks }}</div>
                    </div>
                {% empty %}
                    <p class="no-updates">No updates yet.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Handle video upload form submission
document.addEventListener('DOMContentLoaded', function() {
    const videoForm = document.getElementById('video-upload-form');
    if (videoForm) {
        videoForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(videoForm);
            const uploadBtn = document.getElementById('upload-video-btn');
            const spinner = uploadBtn.querySelector('.spinner-border');
            const progressBar = document.querySelector('#upload-progress .progress-bar');
            const progressContainer = document.getElementById('upload-progress');
            
            // Show loading state
            uploadBtn.disabled = true;
            spinner.classList.remove('d-none');
            progressContainer.classList.remove('d-none');
            
            const xhr = new XMLHttpRequest();
            
            // Upload progress
            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    progressBar.style.width = percentComplete + '%';
                    progressBar.setAttribute('aria-valuenow', percentComplete);
                }
            });
            
            // Request finished
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    const response = JSON.parse(xhr.responseText);
                    
                    if (xhr.status === 200 && response.success) {
                        // Show success message
                        const successMessage = document.getElementById('uploadSuccessMessage');
                        if (successMessage) {
                            successMessage.classList.remove('d-none');
                            // Hide the message after 3 seconds
                            setTimeout(() => {
                                successMessage.classList.add('d-none');
                            }, 3000);
                        }
                        
                        // Hide modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('uploadVideoModal'));
                        if (modal) modal.hide();
                        
                        // Reload the page after a short delay to show the success message
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        // Show error message
                        showToast(response.errors || 'Error uploading video. Please try again.', 'error');
                    }
                    
                    // Reset form and UI
                    videoForm.reset();
                    uploadBtn.disabled = false;
                    spinner.classList.add('d-none');
                    progressContainer.classList.add('d-none');
                    progressBar.style.width = '0%';
                }
            };
            
            xhr.open('POST', videoForm.action, true);
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            xhr.send(formData);
        });
    }
    
    // Handle video deletion
    const deleteVideoForms = document.querySelectorAll('.delete-video-form');
    deleteVideoForms.forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (confirm('Are you sure you want to delete this video? This action cannot be undone.')) {
                const form = e.target;
                const formData = new FormData(form);
                
                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Reload the page to reflect changes
                        window.location.reload();
                    } else {
                        showToast('Error deleting video. Please try again.', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('An error occurred. Please try again.', 'error');
                });
            }
        });
    });
});

// Add form control classes to all form fields
document.addEventListener('DOMContentLoaded', function() {
    const formControls = document.querySelectorAll('input, select, textarea');
    formControls.forEach(control => {
        if (!control.classList.contains('form-control') && !control.classList.contains('form-select')) {
            if (control.tagName === 'SELECT') {
                control.classList.add('form-select');
            } else {
                control.classList.add('form-control');
            }
        }
    });

    // Handle comment form submission with AJAX
    const commentForm = document.getElementById('comment-form');
    if (commentForm) {
        // Handle form submission
        commentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(commentForm);
            const submitButton = commentForm.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;
            
            // Show loading state
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="bi bi-arrow-repeat animate-spin"></i> Posting...';
            
            // Send AJAX request
            fetch(commentForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Add new comment to the top of the list
                    const commentsList = document.getElementById('comments-list');
                    const emptyMessage = commentsList.querySelector('.text-center');
                    
                    if (emptyMessage) {
                        commentsList.innerHTML = ''; // Remove the "No comments yet" message
                    }
                    
                    // Create new comment element
                    const commentHtml = `
                        <div class="comment-item bg-gray-800/50 border border-gray-700 rounded-lg p-4 mb-4" id="comment-${data.comment_id}">
                            <div class="flex items-start space-x-3">
                                <img src="${data.user_avatar}" 
                                     alt="${data.user_name}" 
                                     class="w-10 h-10 rounded-full object-cover bg-gray-700">
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <span class="font-medium text-white">${data.user_name}</span>
                                            <span class="text-xs text-gray-400 ml-2">
                                                Just now
                                            </span>
                                        </div>
                                        <form action="{% url 'home:delete_comment' 0 %}".replace('0', ${data.comment_id}) 
                                              method="post" class="comment-delete-form">
                                            {% csrf_token %}
                                            <button type="submit" class="text-gray-400 hover:text-red-400 transition-colors"
                                                    onclick="return confirm('Are you sure you want to delete this comment?')">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                    <div class="mt-1 text-gray-300">
                                        ${data.content.replace(/\n/g, '<br>')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Insert new comment at the top
                    commentsList.insertAdjacentHTML('afterbegin', commentHtml);
                    
                    // Clear the form
                    commentForm.reset();
                    
                    // Add event listener to the new delete button
                    const newDeleteForm = document.querySelector(`#comment-${data.comment_id} .comment-delete-form`);
                    if (newDeleteForm) {
                        newDeleteForm.addEventListener('submit', handleDeleteComment);
                    }
                    
                    // Show success message
                    showToast('Comment added successfully', 'success');
                } else {
                    // Show error message
                    showToast('Error adding comment: ' + (data.errors?.content?.[0] || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('An error occurred while adding the comment', 'error');
            })
            .finally(() => {
                // Reset button state
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            });
        });
        
        // Add Ctrl+Enter to submit
        const commentTextarea = commentForm.querySelector('textarea');
        if (commentTextarea) {
            commentTextarea.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') {
                    commentForm.dispatchEvent(new Event('submit'));
                }
            });
        }
    }
    
    // Handle comment deletion
    function handleDeleteComment(e) {
        e.preventDefault();
        
        if (!confirm('Are you sure you want to delete this comment?')) {
            return false;
        }
        
        const form = e.target;
        const commentItem = form.closest('.comment-item');
        
        fetch(form.action, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove comment from the DOM
                commentItem.remove();
                
                // If no comments left, show the empty message
                const commentsList = document.getElementById('comments-list');
                if (commentsList && commentsList.children.length === 0) {
                    commentsList.innerHTML = `
                        <div class="text-center py-6 text-gray-400">
                            <i class="bi bi-chat-square-text text-3xl mb-2 block"></i>
                            <p>No comments yet. Be the first to comment!</p>
                        </div>`;
                }
                
                showToast('Comment deleted successfully', 'success');
            } else {
                showToast('Error deleting comment', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('An error occurred while deleting the comment', 'error');
        });
        
        return false;
    }
    
    // Add event listeners to all delete comment forms
    document.querySelectorAll('.comment-delete-form').forEach(form => {
        form.addEventListener('submit', handleDeleteComment);
    });
    
    // Helper function to show toast messages
    function showToast(message, type = 'info') {
        // You can implement a proper toast notification system here
        // For now, we'll use a simple alert
        const alertType = type === 'error' ? 'Error' : 'Success';
        alert(`${alertType}: ${message}`);
    }
});
</script>
{% endblock %}
