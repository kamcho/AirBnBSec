{% extends 'users/base.html' %}
{% load static %}

{% block title %}Select Offender Type{% endblock %}

{% block extra_css %}
<style>
    body { 
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        min-height: 100vh;
        display: flex;
        align-items: flex-start;
        justify-content: center;
        margin: 0;
        padding: 1rem;
    }
    
    @media (min-width: 640px) {
        body {
            align-items: center;
            padding: 1.5rem;
        }
    }
    .conditional-field {
        display: none;
        margin-top: 1rem;
        animation: fadeIn 0.3s ease-in-out;
    }
    .id-input, 
    #foreignerForm .form-control,
    #foreignerForm .form-select,
    #foreignerForm input[type="text"],
    #foreignerForm input[type="email"],
    #foreignerForm input[type="tel"] {
        background: #1f2937 !important;
        border: 1px solid #4b5563 !important;
        color: #e5e7eb !important;
        padding: 0.625rem 0.875rem !important;
        border-radius: 0.5rem !important;
        transition: all 0.2s ease;
        width: 100%;
        font-size: 0.9375rem;
    }

    @media (min-width: 640px) {
        #foreignerForm .form-control,
        #foreignerForm .form-select,
        #foreignerForm input[type="text"],
        #foreignerForm input[type="email"],
        #foreignerForm input[type="tel"] {
            padding: 0.75rem 1rem !important;
            font-size: 1rem;
        }
    }
    
    #foreignerForm .input-group-text {
        background: #1f2937 !important;
        border: 1px solid #4b5563 !important;
        color: #9ca3af !important;
        border-right: none !important;
        border-top-right-radius: 0 !important;
        border-bottom-right-radius: 0 !important;
    }
    
    #foreignerForm .form-label {
        color: #9ca3af;
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
        display: block;
    }
    
    #foreignerForm .form-text {
        color: #6b7280 !important;
        font-size: 0.75rem;
        margin-top: 0.5rem;
    }
    
    #foreignerForm .input-group > .form-control:not(:first-child) {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
        border-left: none;
    }
    
    #foreignerForm .input-group > .input-group-text:first-child {
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
    }
    
    #foreignerForm select.form-select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e") !important;
        background-repeat: no-repeat !important;
        background-position: right 0.5rem center !important;
        background-size: 16px 12px !important;
        -webkit-appearance: none !important;
        -moz-appearance: none !important;
        appearance: none !important;
        padding-right: 2rem !important;
    }
    
    #foreignerForm select.form-select:focus {
        box-shadow: 0 0 0 0.25rem rgba(96, 165, 250, 0.25) !important;
        border-color: #60a5fa !important;
    }
    
    #foreignerForm .input-group > .form-control:focus {
        border-color: #4b5563;
        box-shadow: none;
    }
    
    #foreignerForm .input-group:focus-within .input-group-text {
        border-color: #60a5fa;
    }
    .id-input:focus {
        border-color: #60a5fa !important;
        box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.25) !important;
        outline: none;
    }
    .verify-btn {
        background-color: #1f2937 !important;
        border-color: #4b5563 !important;
        color: #60a5fa !important;
        transition: all 0.2s ease;
    }
    .verify-btn:hover {
        background-color: #1e40af !important;
        color: #ffffff !important;
        border-color: #60a5fa !important;
    }
    .verify-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    #verificationResult {
        font-size: 0.9rem;
        padding: 0.5rem;
        border-radius: 0.375rem;
        display: none;
    }
    .verification-success {
        color: #10b981;
        background-color: #064e3b20;
        border-left: 3px solid #10b981;
    }
    .verification-error {
        color: #ef4444;
        background-color: #7f1d1d20;
        border-left: 3px solid #ef4444;
    }
    .id-label {
        color: #9ca3af;
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
        display: block;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .selection-card {
        background: #1f2937;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        padding: 1.5rem;
        width: 100%;
        max-width: 100%;
        margin: 1rem 0;
    }

    @media (min-width: 640px) {
        .selection-card {
            padding: 2rem;
            max-width: 600px;
            margin: 2rem auto;
        }
    }
    h2 {
        color: white;
        margin-bottom: 2rem;
    }
    .form-check {
        background: #1f2937;
        border: 1px solid #374151;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    @media (min-width: 640px) {
        .form-check {
            padding: 1.25rem;
        }
    }
    .form-check-input {
        margin-right: 0.5rem;
    }
    .form-check-label {
        color: #e5e7eb;
        font-size: 1.1rem;
    }
    .btn-continue {
        margin-top: 1.5rem;
        width: 100%;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        font-weight: 600;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    @media (min-width: 640px) {
        .btn-continue {
            margin-top: 2rem;
            padding: 0.875rem 1.25rem;
            font-size: 1.1rem;
        }
    }
    .btn-continue:hover {
        background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
    }
    .btn-continue:disabled {
        background: #4b5563;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<div class="selection-card">
    <h2>Select Offender Type</h2>
    
    <form method="post" id="offenderTypeForm">
        {% csrf_token %}
        
        <div class="form-check">
            <input class="form-check-input" type="radio" name="offender_type" 
                   id="citizen" value="citizen" required>
            <label class="form-check-label" for="citizen">
                <i class="fas fa-user-tie me-2"></i> Kenyan Citizen
            </label>
            <div id="idNumberField" class="conditional-field">
                <label for="id_number" class="id-label">National ID Number</label>
                <div class="input-group">
                    <span class="input-group-text bg-gray-800 border-gray-700 text-gray-300">
                        <i class="fas fa-id-card"></i>
                    </span>
                    <input type="text" 
                           class="form-control id-input" 
                           id="id_number" 
                           name="id_number" 
                           pattern="[0-9]{8,9}" 
                           title="Please enter a valid Kenyan ID (8-9 digits)"
                           placeholder="e.g., 12345678"
                           autocomplete="off">
                    <button type="button" 
                            class="btn btn-outline-primary verify-btn" 
                            id="verifyIdBtn"
                            title="Verify ID with KRA">
                        <i class="fas fa-check-circle me-1"></i> Verify
                    </button>
                </div>
                <div class="form-text text-gray-400 text-start mt-1 d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-info-circle me-1"></i> 8-9 digit Kenyan National ID</span>
                    <span id="verificationStatus" class="d-none">
                        <i class="fas fa-spinner fa-spin me-1"></i>
                        <span>Verifying...</span>
                    </span>
                </div>
                
                <!-- Hidden fields for verified data -->
                <input type="hidden" id="first_name" name="first_name">
                <input type="hidden" id="last_name" name="last_name">
                
                <!-- Display fields for verified data -->
                <div id="verifiedInfo" class="mt-3" style="display: none;">
                    <div class="mb-3">
                        <label class="form-label text-gray-300">
                            <i class="fas fa-user me-2"></i>First Name
                        </label>
                        <input type="text" class="form-control bg-gray-700 border-gray-600 text-white" 
                               id="display_first_name" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-gray-300">
                            <i class="fas fa-user me-2"></i>Last Name
                        </label>
                        <input type="text" class="form-control bg-gray-700 border-gray-600 text-white" 
                               id="display_last_name" readonly>
                    </div>
                </div>
                
                <div id="verificationResult" class="mt-2"></div>
            </div>
        </div>
        
        <div class="form-check">
            <input class="form-check-input" type="radio" name="offender_type" 
                   id="foreigner" value="foreigner">
            <label class="form-check-label" for="foreigner">
                <i class="fas fa-globe-africa me-2"></i> Foreign National
            </label>
            
            <!-- Foreigner Information Form (initially hidden) -->
            <div id="foreignerForm" class="mt-3 p-4 bg-gray-800 rounded-lg border border-gray-700" style="display: none; background: #1f2937 !important; border-color: #374151 !important;" data-required-fields="foreigner_first_name,foreigner_phone">
                <h5 class="text-white mb-4 text-lg font-medium">Foreign National Information</h5>
                
                <div class="row g-3">
                    <div class="col-12 col-md-6">
                        <label for="foreignerFirstName" class="form-label">
                            <i class="fas fa-user me-2"></i>First Name <span class="text-red-500">*</span>
                        </label>
                        <input type="text" 
                               class="form-control bg-gray-700 border-gray-600 text-white" 
                               id="foreignerFirstName" 
                               name="foreigner_first_name"
                               data-required="true"
                               placeholder="Enter first name">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="foreignerLastName" class="form-label">
                            <i class="fas fa-user me-2"></i>Last Name (Optional)
                        </label>
                        <input type="text" 
                               class="form-control bg-gray-700 border-gray-600 text-white" 
                               id="foreignerLastName" 
                               name="foreigner_last_name"
                               placeholder="Enter last name">
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="foreignerId" class="form-label">
                        <i class="fas fa-passport me-2"></i>Passport/ID Number (Optional)
                    </label>
                    <input type="text" 
                           class="form-control bg-gray-700 border-gray-600 text-white" 
                           id="foreignerId" 
                           name="foreigner_id"
                           placeholder="Enter passport or ID number">
                </div>
                
                <div class="mb-3">
                    <label for="foreignerEmail" class="form-label">
                        <i class="fas fa-envelope me-2"></i>Email Address
                    </label>
                    <input type="email" 
                           class="form-control bg-gray-700 border-gray-600 text-white" 
                           id="foreignerEmail" 
                           name="foreigner_email"
                           placeholder="e.g., example@domain.com">
                    <div class="form-text">At least one contact method is required</div>
                </div>
                
                <div class="mb-3">
                    <label for="foreignerPhone" class="form-label">
                        <i class="fas fa-phone me-2"></i>Phone Number <span class="text-red-500">*</span>
                    </label>
                    <div class="input-group">
                        <span class="input-group-text p-0" style="min-width: 130px; background: #1f2937 !important; border: 1px solid #4b5563 !important; border-right: none !important;">
                            <span class="px-2 text-gray-300">+</span>
                            <select class="form-select form-select-sm border-0 text-white ps-1 pe-3 h-100" id="countryCode" name="country_code" style="background: #1f2937 !important; cursor: pointer;">
                                <option value="1">1 (US/CA)</option>
                                <option value="44">44 (UK)</option>
                                <option value="91">91 (IN)</option>
                                <option value="27">27 (ZA)</option>
                                <option value="255">255 (TZ)</option>
                                <option value="256">256 (UG)</option>
                                <option value="250">250 (RW)</option>
                                <option value="254" selected>254 (KE)</option>
                                <option value="255">255 (TZ)</option>
                                <option value="256">256 (UG)</option>
                                <option value="257">257 (BI)</option>
                                <option value="258">258 (MZ)</option>
                                <option value="260">260 (ZM)</option>
                                <option value="263">263 (ZW)</option>
                            </select>
                        </span>
                        <input type="tel" 
                               class="form-control bg-gray-700 border-gray-600 text-white" 
                               id="foreignerPhone" 
                               name="foreigner_phone"
                               data-required="true"
                               placeholder="e.g., 712345678"
                               data-pattern="[0-9]{8,15}">
                    </div>
                    <div class="form-text">Enter phone number without country code</div>
                </div>
            </div>
        </div>
        
        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
            <button type="submit" class="btn btn-primary px-5" id="continueBtn" disabled>
                <i class="fas fa-save me-2"></i>Save Offender
            </button>
            <a href="{% url 'home:incident_detail' pk=incident_id %}" class="btn btn-outline-secondary">
                <i class="fas fa-times me-2"></i>Cancel
            </a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('offenderTypeForm');
    const continueBtn = document.getElementById('continueBtn');
    const radioInputs = document.querySelectorAll('input[type="radio"][name="offender_type"]');
    const idNumberField = document.getElementById('idNumberField');
    const idNumberInput = document.getElementById('id_number');
    
    // Show/hide fields based on selection
    function toggleIdField() {
        const isKenyan = document.getElementById('citizen').checked;
        const isForeigner = document.getElementById('foreigner').checked;
        const foreignerForm = document.getElementById('foreignerForm');
        
        // Toggle Kenyan ID field
        if (idNumberField) {
            idNumberField.style.display = isKenyan ? 'block' : 'none';
            idNumberInput.required = isKenyan;
        }
        
        // Toggle foreigner form
        if (foreignerForm) {
            foreignerForm.style.display = isForeigner ? 'block' : 'none';
        }
        
        // Update form validation
        validateForm();
        
        // Enable/disable continue button based on validation
    }
    
    // Validate form
    function validateForm() {
        const isKenyan = document.getElementById('citizen')?.checked || false;
        const isForeigner = document.getElementById('foreigner')?.checked || false;
        let isValid = true;
        
        if (isKenyan) {
            // For Kenyans, validate ID number
            isValid = idNumberInput.value.match(/^[0-9]{8,9}$/);
        } else if (isForeigner) {
            // For foreigners, first name and phone are required
            const firstName = document.getElementById('foreignerFirstName')?.value.trim();
            const phone = document.getElementById('foreignerPhone')?.value.trim();
            const email = document.getElementById('foreignerEmail')?.value.trim();
            
            // Check required fields
            if (!firstName) {
                isValid = false;
            }
            
            // Phone is required and must be valid
            if (!phone || !/^[0-9]{8,15}$/.test(phone)) {
                isValid = false;
            }
            
            // If email is provided, validate it
            if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                isValid = false;
            }
        }
        
        // Enable/disable continue button
        continueBtn.disabled = !isKenyan && !isForeigner || !isValid;
        
        return isValid;
    }
    
    // Add event listeners
    radioInputs.forEach(radio => {
        radio.addEventListener('change', toggleIdField);
    });
    
    // Function to handle ID number input
    function handleIdNumberInput(e) {
        // Allow only numbers and limit to 10 digits
        const newValue = e.target.value.replace(/[^0-9]/g, '').slice(0, 10);
        if (newValue !== e.target.value) {
            e.target.value = newValue;
        }
        validateForm();
        
        // Enable/disable verify button based on input length
        const verifyBtn = document.getElementById('verifyIdBtn');
        if (verifyBtn) {
            verifyBtn.disabled = newValue.length < 6; // Enable when at least 6 digits
        }
    }

    // Add input event listeners for validation
    if (idNumberInput) {
        // Remove any existing event listeners to prevent duplicates
        idNumberInput.removeEventListener('input', handleIdNumberInput);
        // Add the input event listener
        idNumberInput.addEventListener('input', handleIdNumberInput);
        
        // Also add event listener for paste to clean up pasted content
        idNumberInput.addEventListener('paste', function(e) {
            // Let the paste complete
            setTimeout(() => {
                this.value = this.value.replace(/[^0-9]/g, '').slice(0, 10);
                validateForm();
            }, 0);
        });
    }
    
    // Add input event listeners for foreigner form fields
    const foreignerFormInputs = ['foreignerEmail', 'foreignerPhone', 'foreignerFirstName', 'foreignerLastName'];
    
    foreignerFormInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            // Remove any existing event listeners to prevent duplicates
            input.removeEventListener('input', validateForm);
            // Add the input event listener
            input.addEventListener('input', validateForm);
        }
    });
    
    // Handle Enter key in ID input to trigger verification
    if (idNumberInput) {
        idNumberInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const verifyBtn = document.getElementById('verifyIdBtn');
                if (verifyBtn && !verifyBtn.disabled) {
                    verifyBtn.click();
                }
            }
        });
        idNumberInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('verifyIdBtn').click();
            }
        });
    }
    
    // Initial setup
    toggleIdField();
    
    // Function to handle KRA verification
    async function verifyKraDetails(idNumber) {
        const verifyBtn = document.getElementById('verifyIdBtn');
        const statusEl = document.getElementById('verificationStatus');
        const resultEl = document.getElementById('verificationResult');
        
        try {
            // Show loading state
            verifyBtn.disabled = true;
            statusEl.classList.remove('d-none');
            resultEl.style.display = 'none';
            
            // Call the backend API to verify KRA details
            const response = await fetch(`/api/core/verify-kra/${idNumber}/`);
            const data = await response.json();
            
            // Update UI based on verification result
            if (data.success) {
                const personName = data.data.name || 'the verified individual';
                resultEl.className = 'verification-success mt-2 p-2';
                resultEl.innerHTML = `
                    <div class="mb-2">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>Verified:</strong> ${personName}
                    </div>
                    <div class="mt-3">
                        <p class="mb-2">Is this the person you want to report?</p>
                        <button type="button" class="btn btn-sm btn-success me-2" id="confirmYes">
                            <i class="fas fa-check me-1"></i> Yes, Continue
                        </button>
                        <button type="button" class="px-4 py-1.5 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500" id="confirmNo">
                            <i class="fas fa-times mr-1"></i> The names dont match
                        </button>
                    </div>
                `;
                
                // Function to handle manual details form
                function setupManualDetailsForm() {
                    // Show the manual entry form
                    const formHTML = `
                        <div class="mb-3">
                            <h5 class="text-gray-300 mb-4">Please provide the correct details</h5>
                            <form id="manualDetailsForm">
                                <div class="mb-3">
                                    <label for="manualIdNumber" class="form-label text-gray-300">ID Number</label>
                                    <input type="text" class="form-control bg-gray-800 border-gray-700 text-gray-300" 
                                           id="manualIdNumber" placeholder="e.g., 12345678" pattern="[0-9]{6,10}">
                                </div>
                                <div class="mb-3">
                                    <label for="manualFirstName" class="form-label text-gray-300">First Name <span class="text-red-500">*</span></label>
                                    <input type="text" class="form-control bg-gray-800 border-gray-700 text-gray-300" 
                                           id="manualFirstName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="manualLastName" class="form-label text-gray-300">Last Name</label>
                                    <input type="text" class="form-control bg-gray-800 border-gray-700 text-gray-300" 
                                           id="manualLastName">
                                </div>
                                <div class="mb-3">
                                    <label for="manualPhone" class="form-label text-gray-300">Phone Number <span class="text-red-500">*</span></label>
                                    <input type="tel" class="form-control bg-gray-800 border-gray-700 text-gray-300" 
                                           id="manualPhone" required>
                                </div>
                                <div class="mb-4">
                                    <label for="manualEmail" class="form-label text-gray-300">Email Address</label>
                                    <input type="email" class="form-control bg-gray-800 border-gray-700 text-gray-300" 
                                           id="manualEmail">
                                </div>
                                <div class="d-flex justify-content-end gap-2">
                                    <button type="button" class="px-4 py-2 text-sm font-medium text-gray-300 bg-gray-700 rounded-md hover:bg-gray-600" 
                                            id="cancelManualEntry">
                                        Cancel
                                    </button>
                                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">
                                        Save Details
                                    </button>
                                </div>
                            </form>
                        </div>`;
                    
                    resultEl.innerHTML = formHTML;
                    
                    // Handle form submission with event delegation
                    resultEl.addEventListener('submit', function(e) {
                        if (e.target && e.target.id === 'manualDetailsForm') {
                            e.preventDefault();
                            const idNum = document.getElementById('manualIdNumber').value.trim();
                            const firstName = document.getElementById('manualFirstName').value.trim();
                            const lastName = document.getElementById('manualLastName').value.trim();
                            const phone = document.getElementById('manualPhone').value.trim();
                            const email = document.getElementById('manualEmail').value.trim();
                            
                            // Basic client-side validation for required fields
                            if (!firstName) {
                                alert('First name is required');
                                return;
                            }
                            if (!phone) {
                                alert('Phone number is required');
                                return;
                            }

                            // Show success message and keep values on screen
                            resultEl.innerHTML = `
                                <div class="p-3 bg-green-900/30 border border-green-800 rounded-md">
                                    <div class="flex items-center text-green-400 mb-2">
                                        <i class="fas fa-check-circle mr-2"></i>
                                        <span>Details captured</span>
                                    </div>
                                    <div class="text-gray-300 text-sm">
                                        ${idNum ? `<div><strong>ID:</strong> ${idNum}</div>` : ''}
                                        <div><strong>First Name:</strong> ${firstName}</div>
                                        ${lastName ? `<div><strong>Last Name:</strong> ${lastName}</div>` : ''}
                                        <div><strong>Phone:</strong> ${phone}</div>
                                        ${email ? `<div><strong>Email:</strong> ${email}</div>` : ''}
                                    </div>
                                </div>`;
                        }
                    });
                    
                    // Handle cancel button with event delegation
                    resultEl.addEventListener('click', function(e) {
                        if (e.target && e.target.id === 'cancelManualEntry') {
                            resultEl.innerHTML = '';
                            resultEl.style.display = 'none';
                        }
                    });
                }
                
                // Add event listeners for the confirmation buttons
                document.addEventListener('click', function(e) {
                    // Handle 'The names dont match' button (use closest to catch icon/text clicks)
                    if (e.target && e.target.closest && e.target.closest('#confirmNo')) {
                        const incidentId = window.location.pathname.split('/')[2];
                        const url = new URL(window.location.origin + `/incidents/${incidentId}/add-client-alias/`);
                        url.searchParams.set('id_number', idNumber);
                        url.searchParams.set('api_name', personName);
                        window.location.href = url.toString();
                    }
                    // Handle 'Yes, Continue' button
                    else if (e.target && e.target.closest && e.target.closest('#confirmYes')) {
                        // Extract first and last names from personName
                        const nameParts = personName.split(' ');
                        const firstName = nameParts[0] || '';
                        const lastName = nameParts.length > 1 ? nameParts.slice(1).join(' ') : '';
                        
                        // Update the form fields with verified data
                        document.getElementById('first_name').value = firstName;
                        document.getElementById('last_name').value = lastName;
                        document.getElementById('id_number').value = idNumber;
                        
                        // Update the display fields
                        document.getElementById('display_first_name').value = firstName;
                        document.getElementById('display_last_name').value = lastName;
                        
                        // Show the verified info section
                        document.getElementById('verifiedInfo').style.display = 'block';
                        
                        // Mark as verified
                        resultEl.dataset.verified = 'true';
                        
                        // Show the contact information form
                        resultEl.innerHTML = `
                            <div class="mb-3">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-user-check text-success me-2"></i>
                                    <span>Reporting: <strong>${personName}</strong></span>
                                </div>
                                <div class="mt-3">
                                    <div class="mb-4">
                                        <label for="offenderEmail" class="form-label text-gray-300">
                                            <i class="fas fa-envelope me-2"></i>Email Address
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-gray-800 border-gray-700 text-gray-300">
                                                <i class="fas fa-at"></i>
                                            </span>
                                            <input type="email" 
                                                   class="form-control bg-gray-800 border-gray-700 text-white" 
                                                   id="offenderEmail" 
                                                   placeholder="e.g., example@domain.com">
                                        </div>
                                        <div class="form-text text-gray-500 mt-1">
                                            <i class="fas fa-info-circle me-1"></i> We'll use this to contact the person if needed
                                        </div>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label for="offenderPhone" class="form-label text-gray-300">
                                            <i class="fas fa-phone me-2"></i>Phone Number
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-gray-800 border-gray-700 text-gray-300">
                                                <i class="fas fa-mobile-alt"></i>
                                            </span>
                                            <input type="tel" 
                                                   class="form-control bg-gray-800 border-gray-700 text-white" 
                                                   id="offenderPhone" 
                                                   placeholder="e.g., 712345678">
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                    }
                });

                // Original button click handlers removed - now handled by event delegation above
                document.getElementById('confirmYes').addEventListener('click', function() {
                    // Show the contact information form
                    resultEl.innerHTML = `
                        <div class="mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-user-check text-success me-2"></i>
                                <span>Reporting: <strong>${personName}</strong></span>
                            </div>
                            
                            <div class="mt-3">
                                <div class="mb-4">
                                    <label for="offenderEmail" class="form-label text-gray-300">
                                        <i class="fas fa-envelope me-2"></i>Email Address
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-gray-800 border-gray-700 text-gray-300">
                                            <i class="fas fa-at"></i>
                                        </span>
                                        <input type="email" 
                                               class="form-control bg-gray-800 border-gray-700 text-white" 
                                               id="offenderEmail" 
                                               placeholder="e.g., example@domain.com">
                                    </div>
                                    <div class="form-text text-gray-500 mt-1">
                                        <i class="fas fa-info-circle me-1"></i> We'll use this to contact the person if needed
                                    </div>
                                </div>
                                
                                <div class="mb-4">
                                    <label for="offenderPhone" class="form-label text-gray-300">
                                        <i class="fas fa-phone me-2"></i>Phone Number
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-gray-800 border-gray-700 text-gray-300">
                                            <i class="fas fa-mobile-alt"></i>
                                        </span>
                                        <input type="tel" 
                                               class="form-control bg-gray-800 border-gray-700 text-white" 
                                               id="offenderPhone" 
                                               placeholder="e.g., 712345678" 
                                               pattern="^(?:254|0)?[17]\d{8}$"
                                               title="Please enter a valid Kenyan phone number">
                                    </div>
                                    <div class="form-text text-gray-500 mt-1">
                                        <i class="fas fa-info-circle me-1"></i> Format: 712345678 or 0712345678 or 254712345678
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="backToVerify">
                                        <i class="fas fa-arrow-left me-1"></i> Back
                                    </button>
                                    <button type="button" class="btn btn-primary" id="saveAndContinue">
                                        Save and Continue <i class="fas fa-arrow-right ms-1"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Add event listener for back button
                    document.getElementById('backToVerify').addEventListener('click', function() {
                        // Reset to verification result
                        resultEl.innerHTML = `
                            <div class="mb-2">
                                <i class="fas fa-check-circle me-2"></i>
                                <strong>Verified:</strong> ${personName}
                            </div>
                            <div class="mt-3">
                                <p class="mb-2">Is this the person you want to report?</p>
                                <button type="button" class="btn btn-sm btn-success me-2" id="confirmYes">
                                    <i class="fas fa-check me-1"></i> Yes, Continue
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="confirmNo">
                                    <i class="fas fa-times me-1"></i> No, Try Again
                                </button>
                            </div>
                        `;
                        // Re-attach event listeners
                        setupVerificationConfirmation(personName);
                    });
                    
                    // Add event listener for save and continue
                    document.getElementById('saveAndContinue').addEventListener('click', async function() {
                        const email = document.getElementById('offenderEmail').value;
                        const phone = document.getElementById('offenderPhone').value;
                        const saveBtn = document.getElementById('saveAndContinue');
                        const originalBtnText = saveBtn.innerHTML;
                        
                        // Skip validation for optional fields
                        if (!email && !phone) {
                            alert('Please provide at least one contact method (email or phone)');
                            return;
                        }
                        
                        // Format phone number (ensure it starts with 254)
                        let formattedPhone = phone.replace(/^0/, '254');
                        if (!formattedPhone.startsWith('254')) {
                            formattedPhone = '254' + formattedPhone;
                        }
                        
                        // Show loading state
                        saveBtn.disabled = true;
                        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Saving...';
                        
                        try {
                            // Extract first and last name from personName
                            const nameParts = personName.trim().split(' ');
                            const lastName = nameParts.pop() || '';
                            const firstName = nameParts.join(' ') || '';
                            
                            // Only include fields that have values
                            const clientData = {
                                id_number: idNumber,
                                first_name: firstName,
                                last_name: lastName
                            };
                            
                            if (email) clientData.email = email;
                            if (phone) clientData.phone = formattedPhone;
                            
                            // Create/update client in database
                            const response = await fetch('/api/core/clients/save-verified-client/', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCookie('csrftoken')
                                },
                                body: JSON.stringify(clientData)
                            });
                            
                            const result = await response.json();
                            
                            if (!response.ok) {
                                throw new Error(result.error || 'Failed to save client information');
                            }
                            
                            // Get the incident ID from the URL
                            const incidentId = window.location.pathname.split('/')[2];
                            
                            // Associate client with incident
                            const incidentResponse = await fetch(`/api/core/incidents/${incidentId}/set-client/`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCookie('csrftoken')
                                },
                                body: JSON.stringify({
                                    client_id: result.client_id
                                })
                            });
                            
                            if (!incidentResponse.ok) {
                                const errorData = await incidentResponse.json();
                                throw new Error(errorData.error || 'Failed to update incident');
                            }
                            
                            // Redirect to incident detail page
                            window.location.href = `/incidents/${incidentId}/`;
                            
                        } catch (error) {
                            console.error('Error saving client:', error);
                            alert(`Error: ${error.message}. Please try again.`);
                            saveBtn.disabled = false;
                            saveBtn.innerHTML = originalBtnText;
                        }
                    });
                });
                
                document.getElementById('confirmNo').addEventListener('click', function() {
                    // Reset the form
                    idNumberInput.value = '';
                    resultEl.style.display = 'none';
                    verifyBtn.disabled = false;
                    continueBtn.disabled = true;
                });
            } else {
                resultEl.className = 'verification-error mt-2 p-2';
                resultEl.innerHTML = `
                    <div class="mb-3">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <strong>Verification failed:</strong> ${data.message || 'The provided ID number could not be verified with KRA.'}
                    </div>
                    <div class="alert alert-warning bg-yellow-900/30 border border-yellow-800 p-3 rounded-md">
                        <p class="mb-3">Are you sure this is the ID number the offender provided and verified?</p>
                        <div class="flex gap-3">
                            <a class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700" id="confirmProceed" href="{% url 'home:add_client_info' incident_id=incident.id %}">
                                <i class="fas fa-check me-1"></i> Yes, Continue
                            </a>
                            <button type="button" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700" id="cancelProceed">
                                <i class="fas fa-times me-1"></i> No, Try Again
                            </button>
                        </div>
                    </div>
                `;
                
                // Add event listeners for the confirmation buttons
                document.getElementById('confirmProceed').addEventListener('click', function() {
                    // Mark as manually confirmed
                    resultEl.className = 'verification-success mt-2 p-2';
                    resultEl.innerHTML = `
                        <div class="mb-2">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Manually Verified:</strong> ID ${idNumber}
                        </div>
                        <div class="mt-3">
                            <p class="mb-2">You've chosen to proceed with this ID number.</p>
                            <button type="button" class="btn btn-sm btn-primary" id="continueToDetails">
                                <i class="fas fa-arrow-right me-1"></i> Continue to Next Step
                            </button>
                        </div>
                    `;
                    
                    // Show the details form when continue is clicked
                    document.getElementById('continueToDetails').addEventListener('click', function() {
                        resultEl.innerHTML = `
                            <div class="space-y-4">
                                <h5 class="text-lg font-medium text-gray-100 mb-4">Enter Offender Details</h5>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="form-group">
                                        <label for="firstName" class="block text-sm font-medium text-gray-300 mb-1">
                                            First Name <span class="text-red-500">*</span>
                                        </label>
                                        <input type="text" id="firstName" required
                                            class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-md text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="lastName" class="block text-sm font-medium text-gray-300 mb-1">
                                            Last Name
                                        </label>
                                        <input type="text" id="lastName"
                                            class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-md text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="form-group">
                                        <label for="phone" class="block text-sm font-medium text-gray-300 mb-1">
                                            Phone Number <span class="text-red-500">*</span>
                                        </label>
                                        <div class="relative">
                                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                                <span class="text-gray-400">+254</span>
                                            </div>
                                            <input type="tel" id="phone" required
                                                pattern="[0-9]{9,10}"
                                                title="Please enter a valid Kenyan phone number (10 digits starting with 7 or 1)"
                                                class="w-full pl-14 pr-3 py-2 bg-gray-800 border border-gray-700 rounded-md text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                placeholder="712345678">
                                        </div>
                                        <p class="mt-1 text-xs text-gray-400">Format: 712345678 (10 digits, starts with 7 or 1)</p>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="email" class="block text-sm font-medium text-gray-300 mb-1">
                                            Email Address
                                        </label>
                                        <input type="email" id="email"
                                            class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-md text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            placeholder="optional@example.com">
                                    </div>
                                </div>
                                
                                <div class="flex justify-between pt-4 border-t border-gray-700">
                                    <button type="button" id="backToVerification" class="px-4 py-2 text-sm font-medium text-gray-300 bg-gray-700 rounded-md hover:bg-gray-600">
                                        <i class="fas fa-arrow-left mr-2"></i> Back
                                    </button>
                                    <button type="button" id="submitDetails" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">
                                        Save and Continue <i class="fas fa-arrow-right ml-2"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        // Add event listener for back button
                        document.getElementById('backToVerification').addEventListener('click', function() {
                            resultEl.className = 'verification-success mt-2 p-2';
                            resultEl.innerHTML = `
                                <div class="mb-2">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <strong>Manually Verified:</strong> ID ${idNumber}
                                </div>
                                <div class="mt-3">
                                    <p class="mb-2">You've chosen to proceed with this ID number.</p>
                                    <button type="button" class="btn btn-sm btn-primary" id="continueToDetails">
                                        <i class="fas fa-arrow-right me-1"></i> Continue to Next Step
                                    </button>
                                </div>
                            `;
                            // Re-attach the continue button event listener
                            document.getElementById('continueToDetails').addEventListener('click', arguments.callee);
                        });
                        
                        // Add form submission handler
                        document.getElementById('submitDetails').addEventListener('click', function() {
                            const firstName = document.getElementById('firstName').value.trim();
                            const lastName = document.getElementById('lastName').value.trim();
                            let phone = document.getElementById('phone').value.trim();
                            const email = document.getElementById('email').value.trim();
                            
                            // Basic validation
                            if (!firstName) {
                                alert('Please enter a first name');
                                return;
                            }
                            
                            if (!phone) {
                                alert('Please enter a phone number');
                                return;
                            }
                            
                            // Format phone number (ensure it starts with 254)
                            phone = phone.replace(/^0/, ''); // Remove leading 0 if present
                            if (phone.length === 9) {
                                phone = '254' + phone;
                            } else if (phone.startsWith('254')) {
                                // Already in correct format
                            } else if (phone.length === 10 && phone.startsWith('7')) {
                                phone = '254' + phone.substring(1);
                            }
                            
                            // Get the incident ID from the URL
                            const incidentId = window.location.pathname.split('/')[2];
                            
                            // Prepare the form data
                            const formData = new FormData();
                            formData.append('id_number', idNumber);
                            formData.append('first_name', firstName);
                            if (lastName) formData.append('last_name', lastName);
                            formData.append('phone', phone);
                            if (email) formData.append('email', email);
                            
                            // Show loading state
                            const submitBtn = document.getElementById('submitDetails');
                            const originalBtnText = submitBtn.innerHTML;
                            submitBtn.disabled = true;
                            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving...';
                            
                            // Submit the form data to add offender endpoint
                            fetch(`/incidents/${incidentId}/add-offender/`, {
                                method: 'POST',
                                headers: {
                                    'X-CSRFToken': getCookie('csrftoken')
                                },
                                body: formData
                            })
                            .then(async response => {
                                const contentType = response.headers.get('content-type');
                                
                                // Handle redirect
                                if (response.redirected) {
                                    window.location.href = response.url;
                                    return;
                                }
                                
                                // Check if response is JSON
                                if (contentType && contentType.includes('application/json')) {
                                    const data = await response.json();
                                    if (!response.ok) {
                                        throw new Error(data.error || 'Failed to save details');
                                    }
                                    return data;
                                } else {
                                    // Handle HTML response (likely a form error page)
                                    const text = await response.text();
                                    console.error('Unexpected HTML response:', text.substring(0, 500));
                                    throw new Error('The server returned an unexpected response. Please try again.');
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                // Show a more user-friendly error message
                                let errorMessage = 'An error occurred while saving. ';
                                
                                if (error instanceof SyntaxError) {
                                    errorMessage += 'The server returned an invalid response.';
                                } else {
                                    errorMessage += error.message || 'Please try again later.';
                                }
                                
                                // Show error in a more visible way
                                const errorDiv = document.createElement('div');
                                errorDiv.className = 'bg-red-900/30 border border-red-700 text-red-300 p-3 rounded-md mt-3 flex items-start';
                                errorDiv.innerHTML = `
                                    <i class="fas fa-exclamation-triangle mt-1 mr-2"></i>
                                    <div>
                                        <div class="font-medium">Error Saving Details</div>
                                        <div class="text-sm">${errorMessage}</div>
                                        <button class="mt-2 text-sm text-red-400 hover:text-red-300" onclick="this.parentElement.parentElement.remove()">
                                            Dismiss
                                        </button>
                                    </div>
                                `;
                                
                                // Insert error message after the form
                                const form = document.querySelector('.space-y-4');
                                form.appendChild(errorDiv);
                                
                                // Re-enable the submit button
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = 'Save and Continue <i class="fas fa-arrow-right ml-2"></i>';
                                
                                // Scroll to the error message
                                errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            });
                        });
                    });
                });
                
                document.getElementById('cancelProceed').addEventListener('click', function() {
                    // Clear the input and reset the form
                    idNumberInput.value = '';
                    resultEl.style.display = 'none';
                    verifyBtn.disabled = false;
                    continueBtn.disabled = true;
                    idNumberInput.focus();
                });
            }
        } catch (error) {
            console.error('Error verifying KRA details:', error);
            resultEl.className = 'verification-error mt-2 p-2';
            resultEl.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Error:</strong> Could not complete verification. Please try again.
            `;
        } finally {
            // Hide loading state
            verifyBtn.disabled = false;
            statusEl.classList.add('d-none');
            resultEl.style.display = 'block';
        }
    }
    
    // Helper function to get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Form submission handler
    document.getElementById('offenderTypeForm').addEventListener('submit', async function(e) {
        e.preventDefault(); // Prevent default form submission
        
        const form = e.target;
        const selectedType = document.querySelector('input[name="offender_type"]:checked');
        
        // Validate offender type is selected
        if (!selectedType) {
            alert('Please select an offender type');
            return false;
        }

        // If foreigner is selected, validate those fields
        if (selectedType.value === 'foreigner') {
            const firstName = document.getElementById('foreignerFirstName').value.trim();
            const phone = document.getElementById('foreignerPhone').value.trim();
            
            // Validate first name
            if (!firstName) {
                alert('Please enter the first name');
                document.getElementById('foreignerFirstName').focus();
                return false;
            }
            
            // Validate phone number
            if (!phone) {
                alert('Please enter a phone number');
                document.getElementById('foreignerPhone').focus();
                return false;
            }
            
            // Validate phone number format
            const phonePattern = /^[0-9]{8,15}$/;
            if (!phonePattern.test(phone)) {
                alert('Please enter a valid phone number (8-15 digits)');
                document.getElementById('foreignerPhone').focus();
                return false;
            }
        }
        
        // If we get here, form is valid
        const formData = new FormData(form);
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        
        try {
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
            
            // If we have verified KRA data, include it in the form data
            const verificationResult = document.getElementById('verificationResult');
            if (verificationResult && verificationResult.dataset.verified === 'true') {
                const firstName = document.getElementById('first_name');
                const middleName = document.getElementById('middle_name');
                const lastName = document.getElementById('last_name');
                const idNumber = document.getElementById('id_number');
                
                if (firstName) formData.set('first_name', firstName.value);
                if (middleName) formData.set('middle_name', middleName.value);
                if (lastName) formData.set('last_name', lastName.value);
                if (idNumber) formData.set('id_number', idNumber.value);
            }
            
            // Submit the form programmatically
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                credentials: 'same-origin',
                redirect: 'manual' // Don't follow redirects automatically
            });

            // Check if we got a redirect response
            if (response.status >= 300 && response.status < 400) {
                const redirectUrl = response.headers.get('Location');
                if (redirectUrl) {
                    window.location.href = redirectUrl;
                    return;
                }
            }

            // Try to parse as JSON first
            try {
                const data = await response.json();
                if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                } else if (data.error) {
                    throw new Error(data.error);
                } else {
                    // If no redirect_url in response, go back to incident detail
                    const incidentId = window.location.pathname.split('/')[2];
                    window.location.href = `/incidents/${incidentId}/`;
                }
            } catch (e) {
                // If not JSON, try to get text
                const text = await response.text();
                if (response.ok) {
                    // If response is OK but not JSON, assume it's a redirect in the HTML
                    window.location.reload();
                } else {
                    console.error('Error response:', text);
                    throw new Error('An error occurred while processing your request');
                }
            }
        } catch (error) {
            console.error('Form submission error:', error);
            // Show error message to user
            alert(`Error: ${error.message || 'Failed to submit the form. Please try again.'}`);
        } finally {
            // Reset button state
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
        }
    });
    
    // Add click handler for verify button
    document.getElementById('verifyIdBtn').addEventListener('click', function() {
        const idNumber = idNumberInput.value.trim();
        if (idNumber && idNumber.match(/^[0-9]{6,10}$/)) {
            verifyKraDetails(idNumber);
        } else {
            const resultEl = document.getElementById('verificationResult');
            resultEl.className = 'verification-error mt-2 p-2';
            resultEl.innerHTML = `
                <i class="fas fa-exclamation-circle me-2"></i>
                <strong>Invalid ID:</strong> Please enter a valid 8-9 digit Kenyan ID
            `;
            resultEl.style.display = 'block';
        }
    });
    
    // Only allow form submission if ID is verified for Kenyan citizens
    // This is now handled in the main form submission handler
});
</script>
{% endblock %}